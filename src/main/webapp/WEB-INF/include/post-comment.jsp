<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ÎåìÍ∏Ä</title>
<style>
/* Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f5f5f5;
    padding: 20px;
}

.comment-container { 
    max-width: 800px;
    margin: 40px auto 0;
    padding: 0;
    background: white; 
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 1px 8px rgba(0, 0, 0, 0.06);
    overflow: hidden;
}

/* ÎåìÍ∏Ä Ìó§Îçî */
.comment-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    padding: 20px 24px 16px; 
    border-bottom: 2px solid #f0f0f0;
}

.comment-stats {
    display: flex;
    gap: 20px;
    align-items: center;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #666;
    font-size: 14px;
}

.stat-icon {
    font-size: 16px;
}

/* ÎåìÍ∏Ä Î™©Î°ù */
#commentList {
    padding: 0;
    background: white;
}

.comment-item { 
    background: white; 
    padding: 15px 24px;
    border-bottom: 1px solid #f5f5f5;
    transition: background 0.2s;
    position: relative;
}

.comment-item:hover {
    background: #fafafa;
}

.comment-item-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start;
    margin-bottom: 10px; 
}

.comment-author { 
    display: flex; 
    align-items: flex-start;
    gap: 12px;
    flex: 1;
}

.profile-img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    border: 2px solid #e0e0e0;
}

.comment-main-content {
    flex: 1;
    min-width: 0;
}

.author-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.author-name { 
    font-weight: 700; 
    font-size: 14px; 
    color: #333;
}

/* ÎåìÍ∏Ä ÎÇ¥Ïö© - TipTap Î∑∞Ïñ¥ */
.comment-content { 
    margin: 8px 0;
}

.comment-content .ProseMirror {
    border: none;
    padding: 0;
    background: transparent;
    min-height: auto;
    line-height: 1.6;
    word-break: break-word;
    font-size: 14px;
    color: #444;
}

.comment-content .ProseMirror p {
    margin: 0.5em 0;
}

.comment-content .ProseMirror img {
    max-width: 100%;
    border-radius: 8px;
    margin: 8px 0;
}

.comment-time { 
    font-size: 12px; 
    color: #999; 
    margin-top: 8px;
    display: inline-block;
}

/* ÎçîÎ≥¥Í∏∞ Î©îÎâ¥ */
.comment-more-menu {
    position: absolute;
    right: 10px;
    top: 10px;
}

.btn-more {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px 10px;
    color: #d0d0d0;
    font-size: 22px;
    line-height: 1;
    border-radius: 6px;
    transition: all 0.2s;
}

.btn-more:hover {
    color: #666;
    background: #f0f0f0;
}

.dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    min-width: 120px;
    z-index: 1000;
    margin-top: 6px;
    overflow: hidden;
}

.dropdown-menu.show {
    display: block;
    animation: dropdownFadeIn 0.2s ease;
}

@keyframes dropdownFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dropdown-item {
    padding: 12px 18px;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 13px;
    color: #333;
    transition: background 0.2s;
    font-weight: 500;
}

.dropdown-item:hover {
    background: #f8f8f8;
}

.dropdown-item.danger {
    color: #f5576c;
}

.dropdown-item.danger:hover {
    background: #fff0f2;
}

/* ÏàòÏ†ï Î™®Îìú */
.comment-edit-form {
    margin-top: 10px;
}

.comment-edit-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    background: white;
    border: 1px solid #e0e0e0;
    border-bottom: none;
    border-radius: 8px 8px 0 0;
}

.comment-edit-toolbar button {
    padding: 4px 8px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    color: #666;
    min-width: 28px;
    height: 28px;
}

.comment-edit-toolbar button:hover {
    background: #f5f5f5;
}

.comment-edit-area {
    border: 1px solid #e0e0e0;
    border-radius: 0 0 8px 8px;
    background: white;
    min-height: 100px;
    padding: 12px;
}

.comment-edit-area .ProseMirror {
    min-height: 80px;
    outline: none;
    font-size: 14px;
}

.edit-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 10px;
}

.btn-cancel-edit {
    padding: 8px 16px;
    background: #868f96;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
}

.btn-cancel-edit:hover {
    background: #6c757d;
}

.btn-save-edit {
    padding: 8px 16px;
    background: #4facfe;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
}

.btn-save-edit:hover {
    background: #667eea;
}

.loading, .empty-state { 
    text-align: center; 
    padding: 80px 20px; 
    color: #aaa; 
    font-size: 14px;
    background: white;
}

/* ÎåìÍ∏Ä ÏûëÏÑ± Ìèº */
.comment-write-form { 
    padding: 24px;
    background: #fafbfc;
    border-top: 2px solid #f0f0f0;
}

.write-form-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
}

.write-form-header .profile-img {
    width: 32px;
    height: 32px;
}

.write-form-header .author-name {
    font-weight: 700;
    font-size: 14px;
    color: #333;
}

/* ÎåìÍ∏Ä Toolbar Ïä§ÌÉÄÏùº */
.toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    padding: 10px 12px;
    background: white;
    border: 2px solid #e8e8e8;
    border-bottom: 1px solid #e8e8e8;
    border-radius: 10px 10px 0 0;
}

.toolbar-group {
    display: flex;
    gap: 4px;
    align-items: center;
}

.toolbar-divider {
    width: 1px;
    height: 20px;
    background: #ddd;
    margin: 0 4px;
}

.toolbar-media {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.toolbar-feature {
    display: inline-block;
}

.toolbar button {
    padding: 6px 10px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: #666;
    transition: all 0.2s;
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toolbar button:hover {
    background: #f5f5f5;
    border-color: #ccc;
    color: #333;
}

.toolbar button:active,
.toolbar button.is-active {
    background: #e8f4ff;
    border-color: #4facfe;
    color: #4facfe;
}

.toolbar button strong {
    font-weight: 700;
}

.toolbar button i {
    font-style: italic;
}

.toolbar button s {
    text-decoration: line-through;
}

#commentContent { 
    border: 2px solid #e8e8e8;
    border-top: none;
    border-radius: 0 0 10px 10px; 
    background: white;
    padding: 14px 16px;
    min-height: 100px;
}

#commentContent .ProseMirror {
    min-height: 80px;
    outline: none;
    font-size: 14px;
    line-height: 1.6;
}

#commentContent .ProseMirror p.is-editor-empty:first-child::before {
    content: attr(data-placeholder);
    float: left;
    color: #adb5bd;
    pointer-events: none;
    height: 0;
}

.comment-write-actions { 
    display: flex; 
    justify-content: flex-end; 
    align-items: center;
    margin-top: 14px; 
}

.btn-submit { 
    padding: 12px 28px; 
    background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
    color: white; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    font-size: 14px;
    font-weight: 700;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(86, 171, 47, 0.3);
}

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(86, 171, 47, 0.4);
}

.btn-submit:disabled {
    background: #e0e0e0;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* ÏÉÅÌÉú ÌëúÏãú */
.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 6px;
}

.status-badge.author {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.status-badge.edited {
    background: #FFD89B;
    color: #333;
}

@media (max-width: 768px) {
    .toolbar {
        gap: 4px;
        padding: 8px;
    }
    .toolbar-group {
        gap: 2px;
    }
    .toolbar button {
        padding: 6px 8px;
        font-size: 11px;
        min-width: 28px;
        height: 28px;
    }
}
</style>
</head>
<body>
    <!-- ÎåìÍ∏Ä ÏòÅÏó≠ -->
    <div class="comment-container">
        <!-- ÎåìÍ∏Ä ÌÜµÍ≥Ñ -->
        <div class="comment-header">
            <div class="comment-stats">
                <div class="stat-item">
                    <span class="stat-icon">üí¨</span>
                    <span>ÎåìÍ∏Ä <strong id="commentTotalCount">0</strong></span>
                </div>
            </div>
            
            <div style="font-size: 12px; color: #999;">ÏµúÏã†Ïàú</div>
        </div>
        
        <!-- ÎåìÍ∏Ä Î™©Î°ù -->
        <div id="commentList">
            <div class="loading">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
        </div>
        
        <!-- ÎåìÍ∏Ä ÏûëÏÑ± Ìèº -->
        <c:if test="${not empty sessionScope.userId}">
            <div class="comment-write-form">
                <div class="write-form-header">
                    <img src="${pageContext.request.contextPath}/images/default-avatar.png" 
                         alt="ÌîÑÎ°úÌïÑ" class="profile-img">
                    <span class="author-name">${sessionScope.userId}</span>
                </div>
                
                <!-- ÎåìÍ∏Ä Toolbar -->
                <div id="toolbar" class="toolbar">
                    <!-- Í∏∞Î≥∏ ÌÖçÏä§Ìä∏ Ïä§ÌÉÄÏùº -->
                    <div class="toolbar-group">
                        <button type="button" data-cmd="bold" title="ÍµµÍ≤å"><strong>B</strong></button>
                        <button type="button" data-cmd="italic" title="Í∏∞Ïö∏ÏûÑ"><i>I</i></button>
                        <button type="button" data-cmd="strike" title="Ï∑®ÏÜåÏÑ†"><s>S</s></button>
                        <button type="button" data-cmd="underline" title="Î∞ëÏ§Ñ">U</button>
                        <jsp:include page="/WEB-INF/template/text-style-btn.jsp" />
                    </div>

                    <div class="toolbar-divider"></div>

                    <!-- Í∏∞Îä• Î≤ÑÌäº -->
                    <div class="toolbar-group toolbar-media">
                        <!-- Ïù¥ÎØ∏ÏßÄ -->
                        <div class="toolbar-feature" data-feature="image">
                            <jsp:include page="/WEB-INF/include/image-modal.jsp" />
                        </div>

                        <!-- Ïù¥Î™®ÏßÄ -->
                        <div class="toolbar-feature" data-feature="emoji">
                            <jsp:include page="/WEB-INF/include/emoji-picker.jsp" />
                        </div>

                        <!-- ÎßÅÌÅ¨ -->
                        <div class="toolbar-feature" data-feature="link">
                            <jsp:include page="/WEB-INF/template/link-btn.jsp" />
                        </div>
                    </div>
                </div>
                
                <!-- ÎåìÍ∏Ä ÏûëÏÑ± ÏóêÎîîÌÑ∞ -->
                <div id="commentContent"></div>
                
                <div class="comment-write-actions">
                    <button class="btn-submit" onclick="writeComment()">ÎåìÍ∏Ä ÏûëÏÑ±</button>
                </div>
            </div>
        </c:if>
        
        <c:if test="${empty sessionScope.userId}">
            <div class="comment-write-form" style="text-align: center; padding: 30px;">
                <p style="color: #999; margin-bottom: 15px;">ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</p>
                <a href="${pageContext.request.contextPath}/login.jsp" 
                   style="display: inline-block; padding: 12px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 700;">
                    Î°úÍ∑∏Ïù∏ÌïòÍ∏∞
                </a>
            </div>
        </c:if>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module">
        import { initEditor } from "${pageContext.request.contextPath}/js/editor-init.js";
        import { initViewer } from "${pageContext.request.contextPath}/js/editor-view.js";
        import * as EmojiModule from "${pageContext.request.contextPath}/js/emoji.js";

        // postIdÎ•º request parameter ÎòêÎäî attributeÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
        window.POST_ID = parseInt('${param.postId}') || parseInt('${postId}') || 1;
        
        // ÎåìÍ∏Ä ÏûëÏÑ± ÏóêÎîîÌÑ∞
        let commentEditor = null;
        
        // ÎåìÍ∏Ä Î∑∞Ïñ¥Îì§ÏùÑ Ï†ÄÏû•Ìï† Îßµ
        const commentViewers = new Map();

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§ÏùÑ Ï†ÑÏó≠ÏúºÎ°ú ÏÑ†Ïñ∏
        window.escapeHtml = function(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        };

        // HTML ÏóîÌã∞Ìã∞ ‚Üí Ïã§Ï†ú Î¨∏Ïûê (Ïòà: &quot; ‚Üí ")
        window.htmlDecode = function(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.innerHTML = String(str);
            return div.textContent || div.innerText || '';
        };

        // ÌèâÎ¨∏ÏùÑ TipTap Î¨∏ÏÑúÎ°ú Í∞êÏã∏Í∏∞
        function toTipTapDocFromPlain(text) {
            const t = (text ?? '').toString();
            return {
                type: "doc",
                content: [{ type: "paragraph", content: t ? [{ type: "text", text: t }] : [] }]
            };
        }

        // ÏïàÏ†Ñ ÌååÏÑú: Í∞ùÏ≤¥/JSON/ÌèâÎ¨∏/HTML Î™®Îëê Î∞©Ïñ¥
        function safeParseTipTap(maybe) {
            // Ïù¥ÎØ∏ Í∞ùÏ≤¥Î©¥ Í∑∏ÎåÄÎ°ú
            if (maybe && typeof maybe === 'object') return maybe;

            if (typeof maybe === 'string') {
                let s = maybe.trim();

                // HTML ÏóîÌã∞Ìã∞ Î≥µÏõê
                if (s.includes('&quot;') || s.includes('&lt;') || s.includes('&#')) {
                    s = htmlDecode(s).trim();
                }

                // HTML Î¨∏ÏÑú(Î°úÍ∑∏Ïù∏/ÏóêÎü¨ ÌéòÏù¥ÏßÄ Îì±) ‚Üí Ïã§Ìå® Ï≤òÎ¶¨
                const sLower = s.slice(0, 20).toLowerCase();
                if (sLower.startsWith('<!doctype') || sLower.startsWith('<html') || s.startsWith('<')) {
                    return null;
                }

                // JSONÏ≤òÎüº Î≥¥Ïù¥Î©¥ ÌååÏã± ÏãúÎèÑ
                if (s.startsWith('{') || s.startsWith('[')) {
                    try {
                        return JSON.parse(s);
                    } catch (e) {
                        // JSONÏ≤òÎüº Î≥¥ÏòÄÏßÄÎßå Íπ®Ïßê ‚Üí ÌèâÎ¨∏ÏúºÎ°ú Í∞êÏã∏Í∏∞
                        return toTipTapDocFromPlain(s);
                    }
                }

                // ÏôÑÏ†Ñ ÌèâÎ¨∏
                return toTipTapDocFromPlain(s);
            }

            // null/undefined Îì±
            return toTipTapDocFromPlain('');
        }

        // ÏàòÏ†ï Î≤ÑÌäº Ìï∏Îì§Îü¨: data-*ÏóêÏÑú ÏïàÏ†ÑÌïòÍ≤å Î≥µÏõêÌï¥ Ï†ÑÎã¨
        window.editCommentFromBtn = function(btnEl) {
            const id = parseInt(btnEl.dataset.commentId, 10);
            // data-contentÏóêÎäî HTMLÎ°ú Ïù¥Ïä§ÏºÄÏù¥ÌîÑÎêòÏñ¥ Îì§Ïñ¥Í∞ÄÎØÄÎ°ú Î≥µÏõê
            const raw = htmlDecode(btnEl.dataset.content || '');
            editComment(id, raw);
        };

        window.formatDateTime = function(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return year + '.' + month + '.' + day + ' ' + hours + ':' + minutes;
        };

        jQuery(document).ready(function() {
            // ÎåìÍ∏Ä ÏûëÏÑ± ÏóêÎîîÌÑ∞ Ï¥àÍ∏∞Ìôî
            const commentContent = document.getElementById('commentContent');
            const toolbar = document.getElementById('toolbar');
            
            if (commentContent && toolbar) {
                commentEditor = initEditor(commentContent, toolbar);
                
                // Ïù¥Î™®ÏßÄ Í∏∞Îä• ÏÑ§Ï†ï
                window.openEmojiPicker = EmojiModule.openPicker;
                EmojiModule.setupEmojiSuggestion(commentEditor);
                
                console.log('ÎåìÍ∏Ä ÏûëÏÑ± ÏóêÎîîÌÑ∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            }
            
            loadCommentList();
        });

        /**
         * ÎåìÍ∏Ä Î™©Î°ù Ï°∞Ìöå
         */
        function loadCommentList() {
            jQuery.ajax({
                url: '${pageContext.request.contextPath}/CommentsList.async',
                type: 'GET',
                dataType: 'json',
                data: {
                    postId: window.POST_ID,
                    pageno: 1
                },
                beforeSend: function() {
                    jQuery('#commentList').html('<div class="loading">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>');
                },
                success: function(response, status, xhr) {
                    // ÎîîÎ≤ÑÍπÖ: ÏùëÎãµ Ìó§Îçî/Î≥∏Î¨∏ Î®∏Î¶¨ ÏùºÎ∂Ä Î°úÍπÖ
                    try {
                        console.log('CommentsList.async content-type:', xhr && xhr.getResponseHeader && xhr.getResponseHeader('Content-Type'));
                        if (response && Array.isArray(response.items) && response.items.length > 0) {
                            const first = response.items[0];
                            const peek = (first.text || first.contentJson || first.contentRaw || '').toString();
                            console.log('First item head:', peek.slice(0, 120));
                        }
                    } catch(e) {}

                    if (response && response.ok) {
                        displayCommentList(response.items || []);
                        jQuery('#commentTotalCount').text(response.total ?? (response.items ? response.items.length : 0));
                    } else {
                        jQuery('#commentList').html('<div class="empty-state">' + (response?.error || 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§') + '</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ÎåìÍ∏Ä Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
                    jQuery('#commentList').html('<div class="empty-state">ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</div>');
                }
            });
        }

        /**
         * ÎåìÍ∏Ä ÏûëÏÑ±
         */
        window.writeComment = function() {
            if (!commentEditor) {
                alert('ÏóêÎîîÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            
            const content = commentEditor.getJSON();
            
            // Îπà ÎÇ¥Ïö© Ï≤¥ÌÅ¨
            if (!content || !content.content || content.content.length === 0) {
                alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Ï≤´ Î≤àÏß∏ Î∏îÎ°ùÏù¥ Îπà paragraphÏù∏ÏßÄ ÌôïÏù∏
            const firstBlock = content.content[0];
            if (content.content.length === 1 && 
                firstBlock.type === 'paragraph' && 
                (!firstBlock.content || firstBlock.content.length === 0)) {
                alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const requestData = {
                postId: window.POST_ID,
                text: JSON.stringify(content),
                imageUrl: null
            };
            
            jQuery.ajax({
                url: '${pageContext.request.contextPath}/CommentsCreate.async',
                type: 'POST',
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                data: JSON.stringify(requestData),
                beforeSend: function() {
                    jQuery('.btn-submit').prop('disabled', true).text('ÏûëÏÑ± Ï§ë...');
                },
                success: function(response) {
                    if (response && response.ok) {
                        commentEditor.commands.setContent('');
                        loadCommentList();
                        alert('ÎåìÍ∏ÄÏù¥ ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
                    } else {
                        alert((response && response.error) || 'ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®:', error);
                    alert('ÎåìÍ∏Ä ÏûëÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                },
                complete: function() {
                    jQuery('.btn-submit').prop('disabled', false).text('ÎåìÍ∏Ä ÏûëÏÑ±');
                }
            });
        }

        /**
         * ÎåìÍ∏Ä ÏàòÏ†ï Î™®Îìú
         * originalContentÎäî "Î¨∏ÏûêÏó¥" (JSON Î¨∏ÏûêÏó¥/ÌèâÎ¨∏ Î™®Îëê Í∞ÄÎä•)
         */
        window.editComment = function(commentId, originalContent) {
            const contentDiv = jQuery('.comment-item[data-comment-id="' + commentId + '"] .comment-content');

            // Î¨∏ÏûêÏó¥ÏùÑ ÏïàÏ†ÑÌïòÍ≤å TipTap Î¨∏ÏÑúÎ°ú
            const parsed = safeParseTipTap(originalContent);
            if (!parsed) {
                console.error('ÏàòÏ†ï Î™®Îìú: ÏΩòÌÖêÏ∏†Í∞Ä HTML ÎòêÎäî ÎπÑÏ†ïÏÉÅ:', String(originalContent).slice(0,120));
                alert('ÎåìÍ∏ÄÏùÑ ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÏàòÏ†ï Ìèº ÏÉùÏÑ±
            const editFormId = 'editForm' + commentId;
            const editToolbarId = 'editToolbar' + commentId;
            const editAreaId = 'editArea' + commentId;
            
            const editFormHtml = 
                '<div class="comment-edit-form" id="' + editFormId + '">' +
                '<div class="comment-edit-toolbar" id="' + editToolbarId + '">' +
                '<button type="button" data-cmd="bold" title="ÍµµÍ≤å"><strong>B</strong></button>' +
                '<button type="button" data-cmd="italic" title="Í∏∞Ïö∏ÏûÑ"><i>I</i></button>' +
                '<button type="button" data-cmd="strike" title="Ï∑®ÏÜåÏÑ†"><s>S</s></button>' +
                '</div>' +
                '<div class="comment-edit-area" id="' + editAreaId + '"></div>' +
                '<div class="edit-actions">' +
                '<button class="btn-cancel-edit" onclick="cancelEdit()">Ï∑®ÏÜå</button>' +
                '<button class="btn-save-edit" onclick="updateComment(' + commentId + ')">ÏàòÏ†ï ÏôÑÎ£å</button>' +
                '</div></div>';
            
            contentDiv.html(editFormHtml);
            
            // ÏàòÏ†ï ÏóêÎîîÌÑ∞ Ï¥àÍ∏∞Ìôî
            setTimeout(() => {
                const editArea = document.getElementById(editAreaId);
                const editToolbar = document.getElementById(editToolbarId);
                
                if (editArea && editToolbar) {
                    const editEditor = initEditor(editArea, editToolbar);
                    editEditor.commands.setContent(parsed);
                    
                    // Ï†ÑÏó≠Ïóê Ï†ÄÏû•
                    window['editEditor' + commentId] = editEditor;
                }
            }, 50);
            
            jQuery('.dropdown-menu').removeClass('show');
        }

        window.cancelEdit = function() {
            loadCommentList();
        }

        /**
         * ÎåìÍ∏Ä ÏàòÏ†ï
         */
        window.updateComment = function(commentId) {
            const editEditor = window['editEditor' + commentId];
            
            if (!editEditor) {
                alert('ÏóêÎîîÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const content = editEditor.getJSON();
            
            // Îπà ÎÇ¥Ïö© Ï≤¥ÌÅ¨
            if (!content || !content.content || content.content.length === 0) {
                alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const requestData = {
                commentId: commentId,
                text: JSON.stringify(content),
                imageUrl: null
            };
            
            jQuery.ajax({
                url: '${pageContext.request.contextPath}/CommentsUpdate.async',
                type: 'POST',
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                data: JSON.stringify(requestData),
                beforeSend: function() {
                    jQuery('.btn-save-edit').prop('disabled', true).text('Ï≤òÎ¶¨ Ï§ë...');
                },
                success: function(response) {
                    if (response && response.ok) {
                        delete window['editEditor' + commentId];
                        loadCommentList();
                        alert('ÎåìÍ∏ÄÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.');
                    } else {
                        alert((response && response.error) || 'ÎåìÍ∏Ä ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                        jQuery('.btn-save-edit').prop('disabled', false).text('ÏàòÏ†ï ÏôÑÎ£å');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ÎåìÍ∏Ä ÏàòÏ†ï Ïã§Ìå®:', error);
                    alert('ÎåìÍ∏Ä ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    jQuery('.btn-save-edit').prop('disabled', false).text('ÏàòÏ†ï ÏôÑÎ£å');
                }
            });
        }

        /**
         * ÎåìÍ∏Ä ÏÇ≠Ï†ú
         */
        window.deleteComment = function(commentId) {
            jQuery('.dropdown-menu').removeClass('show');
            
            if (!confirm('ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                return;
            }
            
            const requestData = {
                commentId: commentId
            };
            
            jQuery.ajax({
                url: '${pageContext.request.contextPath}/CommentsDelete.async',
                type: 'POST',
                contentType: 'application/json; charset=UTF-8',
                dataType: 'json',
                data: JSON.stringify(requestData),
                success: function(response) {
                    if (response && response.ok) {
                        loadCommentList();
                        alert('ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    } else {
                        alert((response && response.error) || 'ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                    alert('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            });
        }

        window.toggleDropdown = function(event, commentId) {
            event.stopPropagation();
            const dropdown = jQuery('#dropdown' + commentId);
            const isVisible = dropdown.hasClass('show');
            jQuery('.dropdown-menu').removeClass('show');
            if (!isVisible) {
                dropdown.addClass('show');
            }
        }

        /**
         * ÎåìÍ∏Ä Î™©Î°ù Î†åÎçîÎßÅ
         */
        function displayCommentList(comments) {
            const commentList = jQuery('#commentList');
            commentList.empty();
            
            // Í∏∞Ï°¥ Î∑∞Ïñ¥Îì§ Ï†ïÎ¶¨
            commentViewers.clear();
            
            if (!comments || comments.length === 0) {
                commentList.html('<div class="empty-state">Ï≤´ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî! üìù</div>');
                return;
            }
            
            let visibleCount = 0;
            for (let i = 0; i < comments.length; i++) {
                if (!comments[i].deleted) {
                    const commentHtml = createCommentHtml(comments[i]);
                    commentList.append(commentHtml);
                    
                    // TipTap Î∑∞Ïñ¥ Ï¥àÍ∏∞Ìôî(ÏïàÏ†Ñ ÌååÏÑú ÏÇ¨Ïö©)
                    initCommentViewer(comments[i]);
                    visibleCount++;
                }
            }
            
            if (visibleCount === 0) {
                commentList.html('<div class="empty-state">ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</div>');
            }
        }

        /**
         * ÎåìÍ∏Ä HTML ÏÉùÏÑ±
         * - ÏàòÏ†ï Î≤ÑÌäº: data-*Î°ú ÏïàÏ†ÑÌïòÍ≤å ÏõêÎ¨∏ Ï†ÑÎã¨
         */
        function createCommentHtml(comment) {
            const contextPath = '${pageContext.request.contextPath}';
            
            const profileImgSrc = contextPath + '/images/default-avatar.png';
            const profileImg = '<img src="' + profileImgSrc + '" alt="ÌîÑÎ°úÌïÑ" class="profile-img">';
            
            const timeText = window.formatDateTime(comment.createdAt);
            
            const authorBadge = comment.author ? 
                ' <span class="status-badge author">Í∏ÄÏì¥Ïù¥</span>' : '';
            
            const editedBadge = comment.edited ? 
                ' <span class="status-badge edited">ÏàòÏ†ïÎê®</span>' : '';
            
            let actionButtons = '';
            if (comment.author) {
                // ÏõêÎ¨∏ ÌõÑÎ≥¥: contentJson > text > contentRaw
                const raw = (comment.contentJson ?? comment.text ?? comment.contentRaw ?? '').toString();
                const forDataAttr = window.escapeHtml(raw); // data-*Ïóê ÏïàÏ†Ñ ÏÇΩÏûÖ
                
                actionButtons = 
                    '<div class="comment-more-menu">' +
                    '<button class="btn-more" onclick="toggleDropdown(event, ' + comment.commentId + ')">‚ãÆ</button>' +
                    '<div class="dropdown-menu" id="dropdown' + comment.commentId + '">' +
                    '<button class="dropdown-item" data-comment-id="' + comment.commentId + '" data-content="' + forDataAttr + '" onclick="editCommentFromBtn(this)">ÏàòÏ†ï</button>' +
                    '<button class="dropdown-item danger" onclick="deleteComment(' + comment.commentId + ')">ÏÇ≠Ï†ú</button>' +
                    '</div></div>';
            }
            
            return '<div class="comment-item" data-comment-id="' + comment.commentId + '">' +
                '<div class="comment-item-header">' +
                '<div class="comment-author">' +
                profileImg +
                '<div class="comment-main-content">' +
                '<div class="author-info">' +
                '<span class="author-name">ÏÇ¨Ïö©Ïûê ' + window.escapeHtml(comment.userId) + '</span>' +
                authorBadge +
                editedBadge +
                '</div>' +
                '<div class="comment-content" id="commentContent' + comment.commentId + '"></div>' +
                '<span class="comment-time">' + timeText + '</span>' +
                '</div></div>' +
                actionButtons +
                '</div></div>';
        }

        /**
         * ÎåìÍ∏Ä Î∑∞Ïñ¥ Ï¥àÍ∏∞Ìôî (ÌïµÏã¨: ÏïàÏ†Ñ ÌååÏÑú ÏÇ¨Ïö©)
         */
        function initCommentViewer(comment) {
            const viewerElement = document.getElementById('commentContent' + comment.commentId);
            if (!viewerElement) {
                console.error('Î∑∞Ïñ¥ ÏóòÎ¶¨Î®ºÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:', comment.commentId);
                return;
            }

            // ÏÑúÎ≤ÑÍ∞Ä Î¨¥ÏóáÏùÑ ÎÇ¥Î†§Ï£ºÎì†(ÌòÑÌñâ/Í≥ºÍ±∞/ÌèâÎ¨∏/HTML) ÌõÑÎ≥¥Î•º Ï†ïÌï¥ ÏïàÏ†Ñ ÌååÏã±
            const candidate = (comment.contentJson ?? comment.text ?? comment.contentRaw ?? '').toString();
            let doc = safeParseTipTap(candidate);

            if (!doc) {
                console.error('ÎåìÍ∏Ä ÏΩòÌÖêÏ∏†Í∞Ä JSONÏù¥ ÏïÑÎãå HTMLÏùº Í∞ÄÎä•ÏÑ±:', candidate.slice(0, 120));
                doc = toTipTapDocFromPlain('ÎÇ¥Ïö©ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
            
            const viewer = initViewer(viewerElement, doc);
            commentViewers.set(comment.commentId, viewer);
        }

        // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
        jQuery(document).on('click', function(e) {
            if (!jQuery(e.target).closest('.comment-more-menu').length) {
                jQuery('.dropdown-menu').removeClass('show');
            }
        });
    </script>
</body>
</html>
